<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>4PL System Limit Visualizer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="style.css" rel="stylesheet" type="text/css" />

  <!-- React + ReactDOM + Babel + Tailwind (CDN) -->
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 text-gray-900">
  <div id="root" class="p-6"></div>

  <!-- JSX transpiled in browser -->
  <script type="text/babel" data-presets="react">
    const { useMemo, useState, useId } = React;

    /* --------------------- Helpers --------------------- */
    function logspace(start, stop, num) {
      const arr = new Array(num);
      const logStart = Math.log10(start);
      const logStop = Math.log10(stop);
      for (let i = 0; i < num; i++) {
        const t = i / (num - 1);
        arr[i] = Math.pow(10, logStart + t * (logStop - logStart));
      }
      return arr;
    }

    function fourPL(x, a, b, c, d) {
      return a + (d - a) / (1 + Math.pow(c / x, b));
    }

    function linePath(xs, ys, x2px, y2px) {
      let d = "";
      for (let i = 0; i < xs.length; i++) {
        const X = x2px(xs[i]);
        const Y = y2px(ys[i]);
        d += i === 0 ? `M ${X} ${Y}` : ` L ${X} ${Y}`;
      }
      return d;
    }

    // Local mappers: map to 0..plotW and 0..plotH
    function makeX2pxLocal(xmin, xmax, plotW) {
      const logMin = Math.log10(xmin);
      const logMax = Math.log10(xmax);
      return (x) => {
        const v = (Math.log10(x) - logMin) / (logMax - logMin);
        return v * plotW;
      };
    }

    function makeY2pxLocal(ymin, ymax, plotH) {
      return (y) => {
        const v = (y - ymin) / (ymax - ymin);
        return plotH - v * plotH;
      };
    }

    // Vertical band in local coordinates
    function rectForXSpanLocal(xStart, xEnd, x2px, plotH, fill, opacity) {
      const X1 = x2px(xStart);
      const X2 = x2px(xEnd);
      const x = Math.min(X1, X2);
      const w = Math.max(0, Math.abs(X2 - X1));
      return <rect x={x} y={0} width={w} height={plotH} fill={fill} opacity={opacity} />;
    }

    /* --------------------- Panel --------------------- */
    const WIDTH = 520;
    const HEIGHT = 300;
    const PAD = 12;

    function Panel({ title, pathsData, spansBuilder, yMaxSys }) {
      const clipId = useId();

      // Inner plot box
      const plotX = PAD;
      const plotY = PAD;
      const plotW = WIDTH - 2 * PAD;
      const plotH = HEIGHT - 2 * PAD;

      // Local mappers
      const x2px = useMemo(() => makeX2pxLocal(1e-2, 1e1, plotW), [plotW]);
      const y2px = useMemo(() => makeY2pxLocal(0, 1.2, plotH), [plotH]);

      // Paths in local space
      const truePath = useMemo(
        () => linePath(pathsData.xs, pathsData.yTrue, x2px, y2px),
        [pathsData, x2px, y2px]
      );
      const obsPath = useMemo(
        () => linePath(pathsData.xs, pathsData.yObs, x2px, y2px),
        [pathsData, x2px, y2px]
      );

      return (
        <div className="relative bg-white rounded-2xl shadow p-3">
          {/* fixed title height so both cards align */}
          <div className="text-sm font-medium mb-2 h-6 flex items-center">{title}</div>

          <svg width={WIDTH} height={HEIGHT} className="rounded-xl">
            <defs>
              <clipPath id={clipId}>
                <rect x={plotX} y={plotY} width={plotW} height={plotH} rx="8" ry="8" />
              </clipPath>
            </defs>

            {/* translate to inner plot and clip everything */}
            <g clipPath={`url(#${clipId})`} transform={`translate(${plotX},${plotY})`}>
              {spansBuilder({ x2px, y2px, plotW, plotH })}

              {/* burnout threshold */}
              <line
                x1={0}
                x2={plotW}
                y1={y2px(yMaxSys)}
                y2={y2px(yMaxSys)}
                stroke="currentColor"
                strokeWidth="2"
                strokeDasharray="6 6"
                strokeLinecap="butt"
              />

              {/* curves */}
              <path d={truePath} fill="none" stroke="currentColor" strokeWidth="1.5" strokeDasharray="4 4" strokeLinecap="butt" />
              <path d={obsPath}  fill="none" stroke="currentColor" strokeWidth="3"   strokeLinecap="butt" />
            </g>

            {/* optional frame */}
            <rect x={plotX} y={plotY} width={plotW} height={plotH} fill="none" stroke="transparent" />
          </svg>
        </div>
      );
    }

    /* --------------------- App --------------------- */
    function Interactive4PLWidget() {
      // slider controls the top asymptote d
      const [paramD, setParamD] = useState(1.0);

      // base params
      const a = 0.02;
      const b = 1.4;
      const c = 0.35;
      const xMin = 1e-2;
      const xMax = 1e1;
      const linFactor = 3.0;
      const xLow = c / linFactor;
      const xHigh = c * linFactor;

      // system settings
      const yMaxSys = 0.65;
      const scaleLimited = 1.0;
      const scaleRescued = 0.55;

      // x grid
      const xs = useMemo(() => logspace(xMin, xMax, 500), []);

      // panel data
      const yTrueLimited = useMemo(
        () => xs.map((x) => fourPL(x, a, b, c, paramD) * scaleLimited),
        [xs, paramD]
      );
      const yObsLimited = useMemo(
        () => yTrueLimited.map((y) => Math.min(y, yMaxSys)),
        [yTrueLimited]
      );

      const yTrueRescued = useMemo(
        () => xs.map((x) => fourPL(x, a, b, c, paramD) * scaleRescued),
        [xs, paramD]
      );
      const yObsRescued = useMemo(
        () => yTrueRescued.map((y) => Math.min(y, yMaxSys)),
        [yTrueRescued]
      );

      const idxCut = yTrueLimited.findIndex((y) => y >= yMaxSys);
      const xCutLimited = idxCut <= 0 ? xHigh : xs[idxCut];

      // span builders receive local mappers
      const spansLimitedBuilder = ({ x2px, y2px, plotW, plotH }) => (
        <>
          {/* system allowed region below burnout */}
          <rect
            x={0}
            y={y2px(yMaxSys)}
            width={plotW}
            height={y2px(0) - y2px(yMaxSys)}
            fill="currentColor"
            opacity="0.10"
          />
          {/* remaining linear range */}
          {rectForXSpanLocal(xLow, Math.min(xCutLimited, xHigh), x2px, plotH, "#66b3ff", 0.18)}
          {/* lost due to burnout */}
          {xCutLimited < xHigh && rectForXSpanLocal(Math.max(xCutLimited, xLow), xHigh, x2px, plotH, "#ff9999", 0.25)}
        </>
      );

      const spansRescuedBuilder = ({ x2px, y2px, plotW, plotH }) => (
        <>
          <rect
            x={0}
            y={y2px(yMaxSys)}
            width={plotW}
            height={y2px(0) - y2px(yMaxSys)}
            fill="currentColor"
            opacity="0.10"
          />
          {rectForXSpanLocal(xLow, xHigh, x2px, plotH, "#66b3ff", 0.18)}
        </>
      );

      return (
        <div className="w-full min-h-screen bg-gray-50 text-gray-900 p-6">
          <div className="max-w-[1200px] mx-auto">
            <h1 className="text-2xl font-semibold mb-4">Interactive Burnout Visualiser</h1>
            <p className="text-sm mb-6">
              Drag the slider to change d and see how the usable linear range is reduced by a fixed system burnout limit in the first panel, and rescued by switching the detection channel in the second panel.
            </p>

            <div className="bg-white rounded-2xl shadow p-4 mb-6 flex items-center gap-4">
              <label className="text-2xl font-semibold whitespace-nowrap">Try to increase your signal â†’</label>
              <input
                type="range"
                min={0.7}
                max={1.35}
                step={0.01}
                value={paramD}
                onChange={(e) => setParamD(parseFloat(e.target.value))}
                className="w-full"
              />
              <div className="w-24 text-right font-mono text-sm">{paramD.toFixed(2)}</div>
            </div>

            <div className="grid grid-cols-12 gap-6 items-stretch">
              {/* Legend on the left */}
              <div className="col-span-3">
                <div className="bg-white rounded-2xl shadow p-4 h-full">
                  <div className="text-sm font-medium mb-3">Legend</div>
                  <ul className="space-y-3 text-sm">
                    <li className="flex items-center gap-3">
                      <span className="inline-block w-4 h-4 rounded" style={{background:"rgba(0,0,0,0.10)"}} />
                      System allowed range
                    </li>
                    <li className="flex items-center gap-3">
                      <span className="inline-block w-4 h-4 rounded" style={{background:"#66b3ff", opacity:0.18}} />
                      Validated linear range
                    </li>
                    <li className="flex items-center gap-3">
                      <span className="inline-block w-4 h-4 rounded" style={{background:"#ff9999", opacity:0.25}} />
                      Lost due to burnout
                    </li>
                    <li className="flex items-center gap-3">
                      <span className="inline-block h-0.5 w-6 border-t border-dashed" />
                      Burnout threshold
                    </li>
                    <li className="flex items-center gap-3">
                      <span className="inline-block h-0.5 w-6 border-t" />
                      Observed (after system limit)
                    </li>
                    <li className="flex items-center gap-3">
                      <span className="inline-block h-0.5 w-6 border-t" style={{borderTopStyle:"dashed"}} />
                      True assay response
                    </li>
                  </ul>
                </div>
              </div>

              {/* Two panels */}
              <div className="col-span-9 grid grid-cols-1 md:grid-cols-2 gap-6">
                <Panel
                  title="1. The system limit can affect assay dynamic range"
                  pathsData={{ xs, yTrue: yTrueLimited, yObs: yObsLimited }}
                  spansBuilder={spansLimitedBuilder}
                  yMaxSys={yMaxSys}
                />
                <Panel
                  title="2. Rescued: Sample dilution or lower sensitivity detection channel (NIR or IR)"
                  pathsData={{ xs, yTrue: yTrueRescued, yObs: yObsRescued }}
                  spansBuilder={spansRescuedBuilder}
                  yMaxSys={yMaxSys}
                />
              </div>
            </div>
          </div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(<Interactive4PLWidget />);
  </script>
</body>
</html>
